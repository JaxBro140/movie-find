<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Join Server</title>
<style>
  body { font-family: Arial; background:#111; color:#eee; text-align:center; }
  .screen { display:none; padding:20px; }
  .box { background:#222; padding:20px; border-radius:10px; width:350px; margin:auto; }
  input, button {
    width:100%; padding:10px; margin:8px 0; border-radius:6px; border:none;
  }
  button { background:#10b981; color:#022c22; cursor:pointer; }
  button:hover { background:#059669; }
</style>
</head>
<body>

<!-- NAME ENTRY -->
<div id="nameScreen" class="screen" style="display:block;">
  <div class="box">
    <h2>Enter Your Name</h2>
    <input id="playerNameInput" placeholder="Your name">
    <button onclick="submitName()">Continue</button>
  </div>
</div>

<!-- WAITING -->
<div id="waiting" class="screen">
  <div class="box">
    <h2>Waiting For Host...</h2>
  </div>
</div>

<!-- QUESTION -->
<div id="questionScreen" class="screen">
  <div class="box">
    <h2 id="questionText"></h2>
    <input id="answerInput" placeholder="Your answer">
    <button onclick="submitAnswer()">Submit</button>
  </div>
</div>

<script>
let playerId = "player_" + Math.random().toString(36).substring(2, 8);
let serverCode = new URLSearchParams(location.search).get("code");
let playerName = "";

// ---------------------------
// PLAYER ENTERS NAME
// ---------------------------
function submitName() {
  playerName = document.getElementById("playerNameInput").value.trim();
  if (!playerName) return alert("Enter a name");

  joinServer();
}

// ---------------------------
// JOIN SERVER
// ---------------------------
function joinServer() {
  let server = JSON.parse(localStorage.getItem("server"));

  if (!server || server.code !== serverCode) {
    alert("Invalid server code");
    return;
  }

  // Add player if new
  if (!server.players[playerId]) {
    server.players[playerId] = { 
      name: playerName,
      score: 0,
      index: 0
    };
  }

  localStorage.setItem("server", JSON.stringify(server));

  show("waiting");
  waitForStart();
}

// ---------------------------
// WAIT FOR HOST TO START
// ---------------------------
function waitForStart() {
  const interval = setInterval(() => {
    const server = JSON.parse(localStorage.getItem("server"));
    if (server.started) {
      clearInterval(interval);
      loadQuestion();
    }
  }, 300);
}

// ---------------------------
// LOAD NEXT QUESTION
// ---------------------------
function loadQuestion() {
  const server = JSON.parse(localStorage.getItem("server"));
  const p = server.players[playerId];

  if (p.index >= server.problems.length) {
    alert("Finished!");
    window.close();
    return;
  }

  document.getElementById("questionText").textContent =
    server.problems[p.index];

  show("questionScreen");
}

// ---------------------------
// SUBMIT ANSWER
// ---------------------------
function submitAnswer() {
  let server = JSON.parse(localStorage.getItem("server"));
  let p = server.players[playerId];
  let problem = server.problems[p.index];
  let answer = document.getElementById("answerInput").value.trim();

  let correct = false;
  try { correct = eval(problem) == answer; } catch {}

  if (correct) p.score += 10;

  p.index++;
  server.players[playerId] = p;

  localStorage.setItem("server", JSON.stringify(server));

  loadQuestion();
}

// ---------------------------
// SCREEN SWITCHER
// ---------------------------
function show(id) {
  document.querySelectorAll(".screen").forEach(s => s.style.display = "none");
  document.getElementById(id).style.display = "block";
}
</script>

</body>
</html>
